## 文件管理

程序和数据不能一直放在内存中，（断电或者容量有限）需要放在外存中，对其直接管理十分复杂，因此通过文件的形式来进行管理。又引入文件系统，通过文件系统来管理文件，实现按名访问。

文件：存储在长期存储设备或短期存储设备中的数据流，并且处于文件系统的管理之下。按照性质和用途：系统文件、用户文件、库文件  按照组织形式：普通文件、目录文件、特殊文件 按照数据：文本文件、二进制文件

逻辑结构：A、流式文件（无结构）B、记录式文件（有结构） 物理结构：C、连续结构  D、串联（链式）结构 E、索引结构（在此基础上引入的多级索引结构）

文件系统：1、文件存储空间的管理 2、文件共享 3、按名访问 4、为用户提供接口

 首先看一下硬盘的构造：总容量=柱面数x扇区数x扇区大小x盘片数  

在寻址过程中：1、通过磁道臂找到对应的磁道；2、通过旋转磁盘，读写头找到对应的扇区   平均存取周期=平均寻道时间+平均等待时间+数据传输时间

C、文件存放在连续的物理块中，优点：1、支持顺序存取和随机存取，查找时间短，存取速度快   缺点：1、不利于动态增长（插入删除） 2、存在外部碎片

D、文件存放在不连续的物理块中，各个物理块通过指针链接，优点：1、支持动态增长（插入删除）2、不存在外部碎片问题，磁盘的空间利用率高  缺点：1、查找时间长、随机存取速度慢 2、链表指针占用额外空间

对其进行改进，FAT文件分配表。以簇为单位进行空间分配，簇内地址连续。例如在目录表中存放文件头部对应的地址，剩余部分一次链接。

E、每个文件对应一个索引表，索引表中记录着该文件的逻辑块号与物理块号的对应关系，所有索引表的信息存放在文件说明信息中。优点：1、可以顺序存取和随机存取 2、充分利用存储空间 3、查找效率高  4、支持动态增长和插入删除操作 缺点：索引表本身会占据空间，带来系统开销

但是随着文件的增大，这个索引表可能很长，超过一个物理块，那么需要引入多级索引结构，以二级索引结构为例。首先由文件说明表中的信息得到一级索引表，一级索引表中放置着二级索引表所在的逻辑块号与物理块号的对应关系，据此查找到二级索引表，二级索引表中记录着文件的逻辑块号与物理块号的对应关系。

但是对于实际的系统来说，全部使用多级索引反而会增加查找时间，降低查找效率。因此可以对于一个索引表，前几项直接寻址，后几项多级索引。

##### 文件目录

文件管理的一个目的是实现按名访问（根据文件名找到路径/根据路径找到文件），所以需要对各个文件进行一个记录，也就是FCB，FCB是文件存在的标志，其中记录着文件的（文件名、地址、长度、类型、共享次数、属主、创建时间等）。FCB就构成了文件目录的内容。目录文件以文件目录的形式存放在外存中，需要时调入内存。

对于这个文件目录而言，有多种结构：A、单极结构、B、二级结构、C、多级结构

A、所有文件的FCB放在一个目录文件中，理论上能满足要求，该目录文件存放在固定位置，启动时调入内存中。优点是实现简单；但是随着文件数量的增加，这个表变长，超过一个物理块；并且其中也存在命名受限制、查找效率低的问题。

B、针对A的弊端，引入二级目录。目录文件分成两部分：MFD和UFD，主文件目录和用户文件目录。在主文件目录中记录着各个用户文件目录的地址、长度等信息，在用户文件目录中，记录着该用户的各个文件的FCB。

这种方法能够解决命名限制和查找速度的问题，并在一定程度上解决共享问题。但是可能带来一定的系统开销。查找速度：m+r<=n

C、类似于二级目录结构，继续分，形成多级目录结构，树状结构，只有最底层才有FCB。

##### 目录共享

A、绕道法 B、链接法 C、基本文件目录法 D、基于I节点的硬链接 E、基于I节点的符号链接

A、在当前目录下，向上查找，直到与共享文件路径交叉，然后向下查找，找到对应的共享文件。

B、当前目录中有一个指针指向另一个目录项，实现共享。主要涉及到链接属性+用户数量+地址

C、文件目录分成两部分：BFD基本文件目录和SFD符号文件目录，每项均有对应的ID（系统唯一分配），如0 1 2是BFD、FFD、MFD，SFD等。若要实现共享，则在SFD中增加对应文件名，剩余的ID自动生成。可以这么理解，对于不同的用户，该共享文件的文件名相同，并且都是指向同一个实际的文件。（通过ID来标识）

D、基于I节点的硬链接，与C相类似，不过是基于I节点实现的，也就是要实现共享文件，需要将目录项的节点号修改为一致的，但是可能会出现代理付费的情况。

E、I节点所对应的文件内容是共享文件的路径，但是如果目标文件被删除，回导致路径错误，如果再次新建，则恢复。

##### 存储空间管理

实际上也就是对空闲分区的管理，包括分配、回收、组织等

A、空闲区表 B、空闲区链表 C、位图：二进制01分别代表物理块贡献还是已分配

A、将空闲区的信息记录在一个表中，适合连续文件的外存分配和回收

B、将空闲区链接起来，使用其中一个空闲块来存放指针，链接起来。从第二组开始，第一个块中记录着前面的块的数量和块号，最后一组的这两个数据记录在文件资源表中。

对文件的使用是通过**系统调用或者命令**的方式进行的，主要有：1、对文件的创建、打开、读写、关闭、删除 2、修改用户访问文件权限 3、增加修改删除路径 4、增加删除修改目录 